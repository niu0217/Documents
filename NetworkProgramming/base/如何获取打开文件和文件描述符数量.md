# 如何获取打开文件和文件描述符数量

## 参考

[链接](https://whiteccinn.github.io/2019/12/10/Linux/%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6%E5%92%8C%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%95%B0%E9%87%8F/)

## 1. Linux的文件描述符

文件描述符（FD:file descriptors），也可以说是文件句柄，当某个程序打开文件时，内核返回相应的文件描述符，程序为了处理该文件必须引用此描述符。文件描述符是一个正整数，用以标明每一个被进程所打开的文件和 socket。最前面的三个文件描述符（0，1，2）分别与标准输入（stdin），标准输出（stdout）和标准错误（stderr）对应，后面打开的文件依此类推对应 3、4…… 。

linux 系统对每个用户、进程、或整个系统的可打开文件描述符数量都有一个限制，一般默认为 1024。当我们在系统或应用的日志中碰到“too many open files”错误记录时，这个其实不是说打开的文件过多，而是打开的文件描述符数量已达到了限制，这时就需要增加文件描述符的数量限制了。

## 2. 获取系统打开的文件描述符数量

```bash
$ cat /proc/sys/fs/file-nr
1728	0	9223372036854775807
```

- 第一列 1728 ：为已分配的 FD 数量
- 第二列 0 ：为已分配但尚未使用的 FD 数量
- 第三列 9223372036854775807 ：为系统可用的最大 FD 数量

已用 FD 数量＝为已分配的 FD 数量 - 为已分配但尚未使用的 FD 数量。注意，这些数值是系统层面的。

## 3. 获取进程打开的文件描述符的数据

```c++
//test.cpp

#include<iostream>
#include<vector>
#include <climits>

using namespace std;

int main()
{
    while(1)
    {

    }
}
```

```bash
$ g++ -g -o test test.cpp
$ ./test &
[1] 2550820

$ pidof test
2550820

$ ls -l /proc/2550820/fd
total 0
lrwx------ 1 ubuntu ubuntu 64 Mar 19 16:43 0 -> /dev/pts/0
lrwx------ 1 ubuntu ubuntu 64 Mar 19 16:43 1 -> /dev/pts/0
lrwx------ 1 ubuntu ubuntu 64 Mar 19 16:43 2 -> /dev/pts/0
```

进程test打开了三个文件描述符，分别是0、1、2。

## 4. 更改文件描述符限制

当碰到“too many open files”错误时，就需要增加文件描述符的限制数量，系统的默认文件描述符都比较大，一般来说，只需增加用户或进程的就可以了

### 4.1 用户或进程

```bash
[root@localhost ~]# ulimit -n
1024
[root@localhost ~]# ulimit -n 10240
[root@localhost ~]# ulimit -n
10240
```

注意，使用 ulimit 命令更改后只是在当前会话生效，当退出当前会话重新登录后又会回到默认值 1024，要永久更改可以修改文件 `/etc/security/limit.conf`，如

```bash
[root@localhost ~]#vi /etc/security/limits.conf
```

加入 “abc hard nofile 10240”

- abc：用户名，即允许 test 使用 ulimit 命令更改 FD 限制，最大值不超过 10240，更改后 abc 用户的每一个进程（以 abc 用户运行的进程）可打开的 FD 数量为 10240 个
- hard：限制类型，有 soft/hard 两种，达到 soft 限制会在系统的日志（一般为/var/log/messages）里面记录一条告警日志，但不影响使用。hard，达到这个限制，有日志且会影响使用。
- nofile：限制的内容，nofile - max number of open files
- 1024 ：值

更改后，退出终端重新登录，用 ulimit 看看有没有生效，如果没生效，可以在 abc 用户的.bash_profile 文件加上 ulimit -n 10240 ,以使用户 abc 每次登录时都会将 FD 最大值更改为 10240，如：

```bash
[root@localhost ~]#echo "ulimit -n 10240" >> /home/abc/ .bash_profile
10240
[root@localhost ~]# su - abc
[abc@localhost ~]\$ ulimit -n
10240
```

limit.conf 文件里面本身已有很详细的使用方法。

### 4.2 系统级别

将整个操作系统可以使用的 FD 数量更改为 51200

```bash
[root@localhost ~]# echo "51200" > /proc/sys/fs/file-max
[root@localhost ~]# cat /proc/sys/fs/file-nr
1184    0       51200
```

像这样更改在系统重启后会恢复到默认值，要永久更改可以在 sysctl.conf 文件加上 fs.file-max = 51200

```bash
[root@localhost ~]# echo "fs.file-max = 51200" >> /etc/sysctl.conf
```

## 5. 获取打开的文件数量

linux 的一切皆为文件，那么如何知道系统/应用打开了哪些或是多少个文件呢？很简单，用 lsof 命令就行了，lsof，list open files 的简写，可列出程序或系统正在使用的文件。

### 5.1 获取整个系统打开的文件数量

```bash
# lsof |wc -l
7388
```

### 5.2 获取某个用户打开的文件数量

```bash
# lsof -u ubuntu |wc -l
358
```

+ ubuntu是我的用户名

补充知识：如何查看用户名？

（1）查看当前用户名：

```bash
# whoami
root
```

（2）查看系统中的所有的用户名

```bash
# cat /etc/passwd
```

```bash
# 只是想查看当前系统上有哪些账号 只输出用户名
# cut -d: -f1 /etc/passwd
root
daemon
bin
sys
sync
games
man
lp
mail
news
uucp
proxy
www-data
backup
list
irc
gnats
nobody
systemd-network
systemd-resolve
systemd-timesync
messagebus
syslog
_apt
tss
uuidd
tcpdump
landscape
pollinate
sshd
systemd-coredump
ubuntu
lxd
ntp
_rpc
statd
lighthouse
rtkit
dnsmasq
usbmux
avahi
cups-pk-helper
pulse
geoclue
saned
colord
gdm
```

### 5.3 获取某个程序打开的文件数量

```c++
//test.cpp

#include<iostream>
#include<vector>
#include <climits>

using namespace std;

int main()
{
    while(1)
    {

    }
}
```

```bash
# g++ -g -o test test.cpp
# ./test &
[1] 2555839

# lsof -p 2555839 | wc -l
12
```

