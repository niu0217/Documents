# C++的lambda

## 1. 问题

### 1.1 lambda的引用捕获会改变外部的值吗

当使用引用捕获（`[&]`或`[&, specific_variable]`）时，lambda表达式可以访问并修改外部的变量。这意味着如果你在lambda函数体内修改了通过引用捕获的变量，那么外部变量的值也会被改变。

以下是一个例子：

```c++
int x = 10;
auto lambda = [&](int y) {
    x += y; // 修改通过引用捕获的外部变量x
};

lambda(5);
std::cout << "x after calling lambda: " << x << std::endl; // 输出：15
```

在这个例子中，我们创建了一个lambda表达式，它通过引用捕获了外部变量`x`。在lambda函数体内，我们将`x`的值增加了传入的参数`y`。因此，当调用lambda函数并传递参数5时，外部变量`x`的值将变为15。

需要注意的是，如果外部变量的生命周期比lambda表达式短，或者在lambda表达式执行之前就被销毁，那么通过引用捕获该变量可能会导致未定义的行为。因此，在使用引用捕获时，需要确保lambda表达式不会超出外部变量的有效范围。如果只需要读取外部变量的值而不改变它，可以使用常量引用捕获（`[const &]`或`[&, const specific_variable]`）。

### 1.2 lambda函数体内的变量特征？

在lambda函数体内，变量具有以下特征：

1. **作用域**：
   - Lambda函数体内的变量具有与常规函数相同的作用域规则。它们只在lambda函数体内可见和可用。
2. **捕获的变量**：
   - 根据lambda表达式的捕获列表，可以访问和（可能）修改外部的变量。这些变量可能是通过值或引用捕获的。
   - 通过值捕获的变量在lambda函数体内是原始变量的副本，对这些副本的修改不会影响到外部的原始变量。
   - 通过引用捕获的变量可以直接访问和修改外部的原始变量。
3. **局部变量**：
   - Lambda函数体内部可以定义和使用局部变量。这些变量的作用域仅限于lambda函数体内部。
4. **mutable关键字**：
   - 默认情况下，lambda函数体被隐式声明为`const`，这意味着你不能修改通过值捕获的变量或lambda函数体内的任何数据成员。如果需要修改这些变量，可以在lambda表达式的开始处添加`mutable`关键字。
5. **返回值**：
   - Lambda函数可以有返回值，这取决于其定义的返回类型。如果省略了返回类型，编译器会尝试从函数体推断返回类型。
6. **异常处理**：
   - Lambda函数可以抛出和捕获异常，就像常规函数一样。
7. **闭包**：
   - Lambda函数创建了一个闭包，这意味着它能够记住在其定义时存在的自由变量（即被捕获的变量）的值或引用。即使在lambda函数被定义的上下文之外，这些变量的值或引用依然可以被访问。

总的来说，lambda函数体内的变量特性与常规函数相似，但其独特之处在于它可以捕获并访问定义时的外部变量，形成一个闭包环境。同时，通过使用`mutable`关键字和不同的捕获方式（值或引用），可以控制lambda函数对这些变量的访问和修改权限。

## 2. 基本概念

Lambda表达式是C++（以及其他一些编程语言如Java、Python等）中的一种功能，它允许你创建匿名函数。Lambda表达式的语法简洁，可以在代码中直接定义和使用小的、临时的函数对象，而无需为其命名或定义在单独的函数体内。

在C++中，lambda表达式的通用形式如下：

```c++
[capture_list] (parameter_list) -> return_type { function_body }
```

- **capture_list**：捕获列表，定义了lambda表达式可以访问的外部变量。它可以是以下几种形式：
  - `[&]`：捕获所有外部变量为引用。
  - `[=]`：捕获所有外部变量为值。
  - `[variable1, &variable2]`：捕获特定变量，其中`variable1`按值捕获，`variable2`按引用捕获。
  - `[this]`：捕获当前对象的指针。
- **parameter_list**：参数列表，与常规函数的参数列表相同。
- **return_type**：返回类型，可以省略如果编译器可以从函数体推断出来。
- **function_body**：函数体，包含lambda表达式要执行的代码。

例如，以下是一个简单的C++ lambda表达式：

```c++
auto add = [](int a, int b) -> int {
    return a + b;
};

int result = add(3, 4); // result will be 7
```

在这个例子中，我们定义了一个名为`add`的lambda表达式，它接受两个整数参数并返回它们的和。然后我们使用这个lambda表达式来计算结果。

Lambda表达式常常用于算法和容器的遍历、事件处理、回调函数等场景，因为它们提供了一种简洁的方式来定义和传递小型函数对象。